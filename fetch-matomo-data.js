import { Octokit } from 'octokit'
import   fetch from 'node-fetch'
import { parse } from 'yaml'
import { writeFileSync } from 'node:fs'

const octokit = new Octokit({
	userAgent: "darwin-version-info-fetcher/1.0.0",
	request: {fetch}
})

const matomoYamlFile = await octokit.rest.repos.getContent({
	mediaType: { format: "raw" },
	owner: 'matomo-org',
	repo: 'device-detector',
	path: 'regexes/oss.yml'
})

const matomoList = parse(matomoYamlFile.data)
const iOSdarwinEntryQuery = entry => entry.name == 'iOS' && entry.hasOwnProperty('versions')
const matomoIOSDarwinEntry = matomoList.find(iOSdarwinEntryQuery)
if (matomoIOSDarwinEntry == undefined) {
	console.error('No darwin list found in matomo file')
	process.exit(1)
}

const removeBackslashes = ({version, regex}) => ({version, regex: regex.replaceAll('\\', '')})
const iOSdarwinList = matomoIOSDarwinEntry.versions.map(removeBackslashes)

const jsonList = JSON.stringify(
	{
		scrapeDate: new Date(),
		note: `This file is automatically generated from scraped data coming from ${matomoYamlFile.url}`,
		origin: matomoYamlFile.url,
		'Darwin iOS lookup info': iOSdarwinList,
	}
)

writeFileSync('darwin-iOS-list.json', jsonList)